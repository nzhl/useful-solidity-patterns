# å †æ ˆè¿‡æ·±çš„è§£å†³æ–¹æ¡ˆ
- [ğŸ“œ ç¤ºä¾‹ä»£ç ](./StackTooDeep.sol)
- [ğŸ æµ‹è¯•](../../test/StackTooDeep.t.sol)

EVM æ˜¯åŸºäºæ ˆçš„ï¼Œè¿™æ„å‘³ç€å¤§å¤šæ•° EVM æŒ‡ä»¤å°†ä»æ ˆé¡¶å–å‡ºå‚æ•°ï¼Œè€Œæ ˆæ˜¯ä¸€ç§å°å‹çš„ã€ç‹¬ç‰¹å†…å­˜ï¼Œç”¨äºå­˜å‚¨å·¥ä½œæ•°æ®ï¼ˆé€šå¸¸æ˜¯å±€éƒ¨å˜é‡ï¼‰ã€‚

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
n+2 â”‚        b          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â–º ADD(a,b)â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       a + b       â”‚ n+1
n+1 â”‚        a          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚        ...        â”‚  n
 n  â”‚        ...        â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    le stack
           le stack
```

åœ¨ Solidity ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå¤§å¤šæ•°å‡½æ•°å‚æ•°å’Œå˜é‡ä¹Ÿä¼šå­˜æ”¾åœ¨æ ˆä¸­ï¼Œå¹¶åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ ¹æ®éœ€è¦è¿›è¡Œæ´—ç‰Œã€‚æ ˆæ€»å…±å¯å®¹çº³ 1024 ä¸ª 32 å­—èŠ‚çš„å€¼ï¼Œä½†åœ¨ä»»ä½•æ—¶å€™éƒ½åªèƒ½ç›´æ¥è®¿é—®é¡¶éƒ¨çš„ 32 ä¸ªæ§½ä½å¯¹åº”çš„å€¼ã€‚å› æ­¤ï¼Œåœ¨å¤æ‚çš„å‡½æ•°ä¸­ï¼Œå¾ˆå®¹æ˜“å‡ºç°ç¼–è¯‘å¤±è´¥çš„æƒ…å†µï¼Œå› ä¸ºç¼–è¯‘å™¨ä¼šé‡åˆ°æ ˆä¸å¯è®¿é—®çš„å˜é‡ã€‚

![compiler error](./error.png)

è®©æˆ‘ä»¬æ¥çœ‹çœ‹è§£å†³è¿™ä¸€é—®é¢˜çš„å¸¸è§æ–¹æ³•ã€‚

## ä½¿ç”¨ IR ä»£ç ç”Ÿæˆå™¨è¿›è¡Œç¼–è¯‘

æ–°ç‰ˆæœ¬çš„ `solc`ï¼ˆSolidity ç¼–è¯‘å™¨ï¼‰å»ºè®®ä½¿ç”¨ `--via-ir` å‚æ•°ï¼Œåœ¨ä¼˜åŒ–ä¹‹å‰å…ˆå°† Solidity ä»£ç ç¼–è¯‘æˆ [yul](https://docs.soliditylang.org/en/v0.8.17/yul.html)ã€‚IR ä»£ç ç”Ÿæˆè·¯å¾„èƒ½å¤Ÿè‡ªä¸»åœ°å°†æ ˆå˜é‡ç§»å…¥"å†…å­˜"ï¼ˆå†…å­˜å®¹é‡å¤§ä¸”å¯è‡ªç”±å¯»å€ï¼‰ï¼Œä»¥ç»•è¿‡æ ˆå¤§å°é™åˆ¶ã€‚[Foundry](https://book.getfoundry.sh/config/) å’Œ [Hardhat](https://hardhat.org/hardhat-runner/docs/guides/compile-contracts) éƒ½èƒ½ä¼ é€’æ­¤å‚æ•°ã€‚

è¿™ç§è§£å†³æ–¹æ¡ˆåªéœ€ä½ åšå¾ˆå°‘çš„ä¸€éƒ¨åˆ†å·¥ä½œï¼Œä½†å¯èƒ½æ— æ³•è§£å†³æ‰€æœ‰æƒ…å†µï¼Œè€Œä¸”å¯èƒ½ä¼šå¢åŠ ç¼–è¯‘æ—¶é—´ï¼Œå¹¶å¸¦æ¥ä¸ä¸å¤ªæˆç†Ÿçš„ä»£ç ç”Ÿæˆæµæ°´çº¿ç›¸å…³çš„é£é™©ã€‚æ— è®ºå¦‚ä½•ï¼Œé‡‡ç”¨ä¸Šè¿°æ–¹æ³•ä¸­çš„ä¸€ç§ä¹Ÿå¯èƒ½ä¼šäº§ç”Ÿæ›´æ¸…æ™°ã€æ›´æ˜“äºäººå·¥éªŒè¯çš„ä»£ç ï¼Œæ‰€ä»¥ä¸è¦æ­¢æ­¥äºæ­¤ï¼

## å—ä½œç”¨åŸŸ

åœ¨å¤æ‚çš„å‡½æ•°ä¸­ï¼Œå¹¶ä¸æ˜¯æ¯ä¸ªå£°æ˜çš„å˜é‡åœ¨æ•´ä¸ªå‡½æ•°ä½“ä¸­éƒ½æ˜¯è¢«éœ€è¦çš„ã€‚é€šè¿‡ä¿æŒå˜é‡å£°æ˜ä¸å®é™…ä½¿ç”¨å®ƒä»¬çš„ä»£ç ä¹‹é—´çš„è·ç¦»è¿™ä¸€è‰¯å¥½çš„ç¼–ç ä¹ æƒ¯ï¼Œé€šå¸¸å¯ä»¥è¯†åˆ«å‡ºåœ¨å‡½æ•°ä¸­ç”Ÿå‘½å‘¨æœŸæœ‰é™çš„å˜é‡ã€‚ç„¶åï¼Œä½ å¯ä»¥ä½¿ç”¨èŠ±æ‹¬å·å°†è¿™äº›å£°æ˜å’Œæ“ä½œåŒ…è£¹èµ·æ¥ï¼ˆ`{ ... }`ï¼‰ï¼Œè¿™æ ·ç¼–è¯‘å™¨å°±å¯ä»¥æå‰ä¸¢å¼ƒè¿™äº›å˜é‡ã€‚ä»»ä½•éœ€è¦åœ¨é€»è¾‘ä¹‹å¤–æŒä¹…å­˜åœ¨çš„å˜é‡éƒ½åº”åœ¨å—ä½œç”¨åŸŸä¹‹å¤–å£°æ˜ã€‚

è¯·çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š

```solidity
uint16 feeRateBps = manager.getFeeRate();
uint256 exchangeRate = getExchangeRate(fromToken, toToken);
if (exchangeRate == 0) revert ZeroExchangeRateError();

uint256 toAmount = (fromAmount * exchangeRate) / 1e18;
uint256 feeAmount = (toAmount * feeRateBps) / 1e4;
toAmount -= feeAmount;

fees[toToken][toAmount] += feeAmount;
balances[fromToken][user] -= fromAmount;
balances[toToken][user] += toAmount;

return toAmount;
```

åœ¨ä»£ç å—ç»“æŸæ—¶ï¼Œæœ‰ 4 ä¸ªå±€éƒ¨å˜é‡è¢«æ¨å…¥æ ˆä¸­ã€‚ä½†æ˜¯ï¼Œåªè¦ç¨åŠ é‡æ–°æ’åˆ—å’Œä½¿ç”¨å—ä½œç”¨åŸŸï¼Œæˆ‘ä»¬å°±å¯ä»¥åªæ¨å…¥ 1 ä¸ªå˜é‡ï¼ˆ`toAmount`ï¼‰ï¼š

```solidity
uint256 toAmount;
{
   uint256 exchangeRate = getExchangeRate(fromToken, toToken);
   if (exchangeRate == 0) revert ZeroExchangeRateError();
   toAmount = (fromAmount * exchangeRate) / 1e18;
   {
      uint16 feeRateBps = manager.getFeeRate();
      uint256 feeAmount = (toAmount * feeRateBps) / 1e4;
      toAmount -= feeAmount;
      fees[toToken][toAmount] += feeAmount;
   }
}

balances[fromToken][user] -= fromAmount;
balances[toToken][user] += toAmount;

return toAmount;
```

è¯¥ç‰ˆæœ¬çš„ä»£ç ä¹Ÿå¾ˆå®¹æ˜“éªŒè¯ï¼Œå› ä¸ºä½ ç¡®åˆ‡åœ°çŸ¥é“å±€éƒ¨å˜é‡ç”¨äºå“ªäº›æ“ä½œï¼Œä»¥åŠä½•æ—¶å¯ä»¥å®‰å…¨åœ°é‡Šæ”¾å®ƒã€‚ä»…å‡ºäºè¿™ä¸ªåŸå› ï¼Œå³ä½¿æ²¡æœ‰é‡åˆ°å †æ ˆé—®é¢˜ï¼Œä¹Ÿåº”è¯¥æ›´å¤šåœ°ä½¿ç”¨å—ä½œç”¨åŸŸï¼

## ä½¿ç”¨å†…å­˜ç»“æ„ä½“

ä½ å¯ä»¥æ‰‹åŠ¨å£°æ˜å­˜æ”¾åœ¨ `memory` ä¸­çš„å˜é‡ï¼Œè€Œä¸æ˜¯é€šè¿‡å®šä¹‰ `struct` å°†å˜é‡å­˜å‚¨åˆ°å †æ ˆä¸­ã€‚ä½¿ç”¨è¿™ç§æ–¹å¼æ—¶ï¼Œå †æ ˆä¸­å”¯ä¸€éœ€è¦å­˜å‚¨çš„ä¾¿æ˜¯æŒ‡å‘ç»“æ„ä½“çš„ `memory` åç§»é‡çš„æŒ‡é’ˆï¼Œå› æ­¤å¤šä¸ªå˜é‡å¯ä»¥æœ‰æ•ˆåœ°åˆå¹¶ä¸ºä¸€ä¸ªå †æ ˆé¡¹ã€‚

```solidity
struct ExchangeVars {
   uint16 feeRateBps;
   uint256 exchangeRate;
   uint256 toAmount;
   uint256 feeAmount;
}

...

ExchangeVars memory vars;
vars.feeRateBps = manager.getFeeRate
vars.exchangeRate = getExchangeRate(fromToken, toToken);
... // etc
```

ä½†è¿™ç§æ–¹æ³•çœŸæ­£æœ€æœ‰æ„ä¹‰çš„åœ°æ–¹ï¼Œæ˜¯åœ¨æ¥æ”¶æˆ–è¿”å›å¤šä¸ªå‚æ•°çš„å‡½æ•°ä¸­ï¼Œå› ä¸ºå®ƒæä¾›äº†å³æ—¶çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚å·§åˆçš„æ˜¯ï¼Œæ¥æ”¶æˆ–è¿”å›å¤šä¸ªå‚æ•°çš„å‡½æ•°ç»å¸¸ä¼šé‡åˆ°å †æ ˆè¿‡æ·±çš„é—®é¢˜ï¼Œå› ä¸ºæ¯ä¸ªå‚æ•°éƒ½ä¼šå ç”¨ä¸€ä¸ªå †æ ˆç©ºé—´ã€‚

ä¸ºäº†è¯´æ˜è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬è°ƒæ•´ä¸‹é¢çš„å‡½æ•°ï¼š

```solidity
function _computeExchangeAmounts(
   uint256 toAmount,
   uint256 exchangeRate,
   uint16 feeRateBps
)
   private
   pure
   returns (uint256 feeAmount, uint256 toAmount) 
{
   toAmount = (fromAmount * exchangeRate) / 1e18;
   feeAmount = (toAmount * feeRateBps) / 1e4;
   toAmount -= feeAmount;
}
```

æ”¹ä¸ºé€šè¿‡ struct ä¼ é€’å‚æ•°ï¼Œä»è€Œå‡å°‘å †æ ˆç©ºé—´çš„ä½¿ç”¨ï¼š

```solidity
struct ComputeExchangeAmountsArgs {
   uint256 toAmount;
   uint256 exchangeRate;
   uint16 feeRateBps;
}

function _computeExchangeAmounts(ComputeExchangeAmountsArgs memory args)
   private
   pure
   returns (uint256 feeAmount, uint256 toAmount) 
{
   toAmount = (args.fromAmount * args.exchangeRate) / 1e18;
   feeAmount = (toAmount * args.feeRateBps) / 1e4;
   toAmount -= feeAmount;
}
```

è°ƒç”¨åŒ…å«å¤§é‡å‚æ•°çš„å‡½æ•°æ—¶å®¹æ˜“å‡ºé”™ï¼Œå°¤å…¶æ˜¯åœ¨å¤šä¸ªå‚æ•°ç±»å‹å…¼å®¹çš„æƒ…å†µä¸‹ã€‚æƒ³æƒ³çœ‹ï¼Œå¦‚æœåœ¨é‡æ„è¿‡ç¨‹ä¸­è°ƒæ¢äº†å‚æ•°é¡ºåºï¼Œè€Œæ²¡æœ‰è€ƒè™‘åˆ°æ‰€æœ‰è°ƒç”¨çš„åœ°æ–¹ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µğŸ˜±ï¼æœ‰äº†ç»“æ„ä½“å‚æ•°ï¼Œä½ å°±å¯ä»¥åˆ©ç”¨æœ‰åå­—æ®µæ¥é¿å…ä¾èµ–å‚æ•°çš„é¡ºåºï¼Œè€Œä¸”æ¯ä¸ªå‚æ•°çš„å«ä¹‰ä¹Ÿä¼šæ›´åŠ æ¸…æ™°ã€‚å› æ­¤ï¼Œå³ä½¿æ²¡æœ‰å †æ ˆé—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§å€¼å¾—é‡‡ç”¨çš„æ¨¡å¼ã€‚

```solidity
// Original function call. Argument order matters ğŸ¤”:
... = _computeExchangeAmounts(toAmount, getExchangeRate(fromToken, toToken), manager.getFeeRate());

// New function call with named struct field initializers. Independent of argument order ğŸ˜:
... = _computeExchangeAmounts(ComputeExchangeAmountsArgs({
   toAmount: toAmount,
   exchangeRate: getExchangeRate(fromToken, toToken),
   feeRateBps: manager.getFeeRate()
}));
```

## æ›´å¤šå¥‡æŠ€æ·«å·§

åœ¨æç«¯æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½éœ€è¦é‡‡ç”¨ä¸€äº›å¥‡æŠ€æ·«å·§ã€‚ä½ å¤§æ¦‚ä¸ä¼šé‡åˆ°è¿™äº›æƒ…å†µï¼Œæ‰€ä»¥æˆ‘åªç®€å•ä»‹ç»ä¸€ä¸‹ã€‚

### è¿›å…¥æ–°çš„æ‰§è¡Œä¸Šä¸‹æ–‡

ä»»ä½•æ—¶å€™è¿›è¡Œå¤–éƒ¨å‡½æ•°è°ƒç”¨ï¼ˆè°ƒç”¨å¦ä¸€ä¸ªåˆçº¦æˆ–ä½¿ç”¨ `this.fn()` è¯­æ³•ï¼‰ï¼Œéƒ½ä¼šè¿›å…¥ä¸€ä¸ªæ–°çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå®ƒå¸¦æœ‰ä¸€ä¸ªå…¨æ–°çš„ï¼ˆå‡ ä¹ä¸ºç©ºï¼‰å †æ ˆã€‚å½“ç„¶ï¼Œå¤–éƒ¨è°ƒç”¨ä¼šäº§ç”Ÿä¸€äº›å¼€é”€ï¼Œä½†åŠ å…¥ [EIP-2929](https://eips.ethereum.org/EIPS/eip-2929) åï¼Œå¼€é”€å¤§å¤§é™ä½äº†ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœä½ è°ƒç”¨è‡ªèº«ï¼‰ã€‚è™½ä¸é›…è§‚ï¼Œä½†å¶å°”ä¹Ÿå¯è¡Œã€‚

### ï¼ˆä¸´æ—¶ï¼‰ä½¿ç”¨ `storage`
`storage` çš„è¯»å–å’Œå†™å…¥æ˜¯å‡ºäº†åçš„å¼€é”€å¤§ï¼Œæ‰€ä»¥è¿™ä¸æ˜¯ä¸€ä¸ªå¥½çš„ç­”æ¡ˆã€‚ä½†æ˜¯ï¼Œ`storage` ä¸ä¼šå—åˆ° `memory` æ‰©å±•çš„[äºŒæ¬¡ gas æˆæœ¬](https://github.com/wolflo/evm-opcodes/blob/main/gas.md#a0-1-memory-expansion)çš„å½±å“ã€‚å› æ­¤ï¼Œå½“ä¸ [EIP-2200](https://github.com/ethereum/EIPs/blob/master/EIPS/eip-2200.md) é€€æ¬¾ç»“åˆä½¿ç”¨æ—¶ï¼Œè¯¥æƒ…å†µä¹Ÿè®¸ä¼šé€‚ç”¨ğŸ™ƒã€‚

### é“¾ä¸‹è®¡ç®—
æœ‰æ—¶ï¼Œåˆçº¦çš„å¤§éƒ¨åˆ†è®¡ç®—éƒ½å¯ä»¥åœ¨é“¾ä¸‹è¿›è¡Œï¼Œè®¡ç®—ç»“æœåªéœ€é€šè¿‡é¡¶å±‚è°ƒç”¨ä¼ å…¥å³å¯ï¼Œåˆçº¦åªéœ€æ‰§è¡Œæ›´ç®€å•çš„éªŒè¯æ­¥éª¤å³å¯ã€‚ä¾‹å¦‚ï¼Œä¸å…¶åœ¨é“¾ä¸Šå¯¹æ’åºæ•°æ®è¿›è¡ŒäºŒåˆ†æœç´¢ï¼Œä¸å¦‚åœ¨é“¾ä¸‹è¿›è¡Œæœç´¢ï¼Œç„¶åå°†ç´¢å¼•ä¼ å…¥ï¼Œåˆçº¦åªéœ€éªŒè¯å…¶ä¸ç›¸é‚»æ•°æ®çš„æœ‰æ•ˆæ€§å³å¯ã€‚

### é€šè¿‡ä½è¿ç®—æ‰“åŒ…
æ¯ä¸ªå †æ ˆå€¼ï¼Œæ— è®ºå®ƒå®é™…å£°æ˜ä¸ºå“ªç§å˜é‡ç±»å‹ï¼Œæœ€ç»ˆéƒ½å°†å ç”¨ä¸€ä¸ªå®Œæ•´çš„ 32 å­—èŠ‚æ§½ã€‚å› æ­¤ï¼Œå¦‚æœä½ ä¸å…³å¿ƒç²¾åº¦ï¼ˆä¾‹å¦‚ï¼Œ`uint128` ä¸ `uint256`ï¼‰ï¼Œä½ å¯ä»¥é€šè¿‡ä¸€äº›ä½è¿ç®—å°†å¤šä¸ªå€¼æ‰“åŒ…åˆ°ä¸€ä¸ª `uint256` æˆ– `bytes32` ä¸­ã€‚å½“ç„¶ï¼Œè¿™æ ·åšä¼šå¤§å¤§é™ä½å¯è¯»æ€§ï¼Œè€Œä¸”åœ¨äº¤äº’è¿‡ç¨‹ä¸­ææ˜“å‡ºé”™ï¼Œå› æ­¤è¯·è°¨æ…ä½¿ç”¨è¿™ç§æ–¹æ³•ã€‚