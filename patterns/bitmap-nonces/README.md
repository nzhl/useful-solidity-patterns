# ä½å›¾Nonces

- [ğŸ“œ ç¤ºä¾‹ä»£ç ](./TransferRelay.sol)
- [ğŸ æµ‹è¯•](../../test/TransferRelay.t.sol)

æ‰§è¡Œä¸€ä¸ªæ­¢æŸè®¢å•ï¼Œæˆ–ä¸€ä¸ªæ²»ç†æè®®ï¼Œåˆæˆ–æ˜¯ä¸€ä¸ªå…ƒäº¤æ˜“ã€‚ã€‚ã€‚ç­‰ç­‰è¿™äº›è¡Œä¸ºæœ‰ä»€ä¹ˆå…±åŒä¹‹å¤„ï¼Ÿå®ƒä»¬çš„å…±åŒç‚¹å°±æ˜¯è¿™ç±»æ“ä½œéƒ½åªå¯æ‰§è¡Œä»…ä»…ä¸€æ¬¡ï¼Œä¸èƒ½å¤šæ¬¡ã€‚åœ¨è®¸å¤šä¸»æµåè®®ä¸­ä½ éƒ½èƒ½æ‰¾åˆ°è¿™ç±»æ“ä½œçš„å­˜åœ¨ã€‚è¿™æ ·çš„â€œä»…æ‰§è¡Œä¸€æ¬¡â€çš„ç‰¹æ€§æ˜¯éœ€è¦åœ¨é“¾ä¸Šè¢«ä¿è¯çš„ï¼Œä»¥é˜²æ­¢é‡æ”¾æ”»å‡»ã€‚æƒ³è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œè®¸å¤šåè®®ä¼šä½¿ç”¨ä¸€ç§å…·æœ‰å”¯ä¸€æ€§çš„æ ‡è®°å€¼ï¼ˆnonceï¼‰å¹¶ä¸”ä»¤è¿™ä¸ªå€¼æŒ‡å‘ä¸€ä¸ªç‰¹å®šçš„å…³äºæ­¤äº¤æ˜“çŠ¶æ€å­˜å‚¨ç©ºé—´ï¼Œè¿™ä¸ªç©ºé—´å­˜å‚¨çš„æ•°å€¼å¯ä»¥æŒ‡æ˜è¿™ç¬”äº¤æ˜“æ˜¯å¦å·²è¢«æ‰§è¡Œã€‚

## ç”¨æœ´ç´ çš„æ–¹æ³•å°è¯•

å¦‚ä¸‹è¿™ä¸ªåˆçº¦å¯åšä¸ºä¾‹å­ï¼Œå®ƒæ”¶é›†é“¾ä¸‹è¢«ç­¾ç½²è¿‡çš„æ¶ˆæ¯ï¼Œç­‰å¾…ä¸€æ®µæŒ‡å®šæ—¶é—´ä¹‹åï¼Œåœ¨é“¾ä¸Šå»æ‰§è¡Œå°†ç­¾ç½²è€…æ‰€æŒæœ‰çš„ï¼ˆæ ‡å‡†åˆè§„çš„ï¼‰ERC20ä»£å¸è¿›è¡Œè½¬ç§»ï¼š

```solidity
contract TransferRelay {
    struct Message {
        address from;
        address to;
        uint256 validAfter;
        IERC20 token;
        uint256 amount;
        uint256 nonce;
    }

    mapping (address => mapping (uint256 => bool)) public isSignerNonceConsumed;

    function executeTransferMessage(
        Message calldata mess,
        uint8 v,
        bytes32 r,
        bytes32 s
    )
        external
    {
        require(mess.from != address(0), 'bad from');
        require(mess.validAfter < block.timestamp, 'not ready');
        require(!isSignerNonceConsumed[mess.from][mess.nonce], 'already consumed');
        {
            bytes32 messHash = keccak256(abi.encode(block.chainid, address(this), mess));
            require(ecrecover(messHash, v, r, s) == mess.from, 'bad signature');
        }
        // æ ‡è®°è¿™ä¸ªè¢«æˆæƒçš„äº¤æ˜“çŠ¶æ€ä¸ºå·²è¢«æ‰§è¡Œè¿‡
        isSignerNonceConsumed[mess.from][mess.nonce] = true;
        // æ‰§è¡Œè½¬ç§»äº¤æ˜“
        mess.token.transferFrom(address(mess.from), mess.to, mess.amount);
    }
}
```

æˆ‘ä»¬æœŸå¾…ç­¾ç½²äººåœ¨é€‰å– `nonce` çš„å€¼çš„æ—¶å€™èƒ½å¤Ÿä¿è¯åœ¨ä»–æ‰€æœ‰ç­¾ç½²çš„æ¶ˆæ¯ä¸­è¿™ä¸ªå€¼éƒ½ä¸ä¼šè¢«é‡å¤ä½¿ç”¨ã€‚æˆ‘ä»¬çš„åˆçº¦åˆ©ç”¨è¿™ä¸ª `nonce` å€¼æ¥é”å®šå…¶å¯¹åº”çš„æ¶ˆæ¯å¹¶ä¸”é€šè¿‡ `isSignerNonceConsumed` æ˜ å°„æ¥è®°å½•å…¶ç›®å‰çš„çŠ¶æ€ã€‚è¿™æ–¹æ³•å¾ˆç›´è§‚ï¼Œå®¹æ˜“ç†è§£ã€‚ã€‚ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜å¯ä»¥åšåˆ°æ›´è¿›ä¸€æ­¥ï¼

## å®¡è§†Gasæˆæœ¬

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ ‡è®°æ¶ˆæ¯çš„æ‰§è¡ŒçŠ¶æ€è¿™ä¸€æ“ä½œæ‰€éœ€è¦èŠ±è´¹çš„gasã€‚å› ä¸ºæ¯ä¸€ä¸ª `Message.nonce` éƒ½æŒ‡å‘ä¸€ä¸ªå”¯ä¸€çš„ç©ºé—´å‚¨å­˜æ§½ï¼Œæˆ‘ä»¬å°±éœ€è¦æ¯ä¸€æ¬¡æ ‡è®°çŠ¶æ€çš„æ—¶å€™éƒ½é’ˆå¯¹ä¸€ä¸ªå…¨æ–°çš„**ç©º**å‚¨å­˜æ§½è¿›è¡Œå†™å…¥æ“ä½œã€‚å¯¹äºç©ºå‚¨å­˜æ§½å†™å…¥è¦èŠ±è´¹20k(\*) gasã€‚ä¸ºå¸®åŠ©ç†è§£ï¼Œå¯¹æ¯”èµ·æ¥è¿™ç›¸å½“äºä¸€ç¬”AMMå…‘å¸äº¤æ˜“èŠ±è´¹gasæ•°é‡çš„15%ã€‚å°¤å…¶æ˜¯å¯¹äºå‘ç”Ÿé¢‘ç‡è¾ƒé«˜çš„defiæ“ä½œè€Œè¨€ï¼Œè¿™äº›gasæˆæœ¬å¾ˆå®¹æ˜“ç§¯å°‘æˆå¤šã€‚åä¹‹ï¼Œå‘ä¸€ä¸ª*éç©º*çš„å‚¨å­˜æ§½å†™å…¥å´ä»…éœ€3k(\*) gasã€‚åˆ©ç”¨ä½å›¾nonceæ–¹å¼å¯ä»¥æœ€å°åŒ–æˆ‘ä»¬éœ€è¦å†™å…¥ç©ºå‚¨å­˜æ§½çš„æ¬¡æ•°ï¼Œå°†å¤§éƒ¨åˆ†æ“ä½œæ‰€è€—çš„gasæˆæœ¬èŠ‚çœ85%ã€‚

*(\*) ä¸ç®—ä¸ŠEIP-2929ä¸­çš„è·å–å†·/çƒ­çŠ¶æ€å€¼çš„æˆæœ¬*

## é‡æ–°æ¥è¿‡ï¼Œè¿™æ¬¡åˆ©ç”¨ä½å›¾Noncesæ–¹æ³•

ä»”ç»†æƒ³æƒ³ï¼Œæˆ‘ä»¬å®Œå…¨ä¸éœ€è¦ä¸€æ•´ä¸ª32å­—èŠ‚å¤§å°çš„å­—ç¬¦ä¸²ï¼Œç”šè‡³ä¹Ÿä¸éœ€è¦ä¸€æ•´ä¸ª8æ¯”ç‰¹å¤§å°çš„å¸ƒå°”å€¼æ¥ä»£è¡¨ä¸€æ¡æ¶ˆæ¯çš„æ‰§è¡ŒçŠ¶æ€ã€‚æˆ‘ä»¬ä»…éœ€è¦1ä¸ªæ¯”ç‰¹å¤§å°ï¼ˆ`0` or `1`ï¼‰è¶³çŸ£ã€‚æ‰€ä»¥è‹¥æ˜¯æˆ‘ä»¬æƒ³è¦å°†å†™å…¥ç©ºå‚¨å­˜æ§½çš„æ¬¡æ•°æœ€å°åŒ–ï¼Œç›¸å¯¹äºæŠŠnoncesæ˜ å°„åˆ°ä¸€*æ•´ä¸ª*å‚¨å­˜æ§½çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¤§å¯ä»¥é‡‡ç”¨å°†å…¶æ˜ å°„åˆ°ä¸€ä¸ªå‚¨å­˜æ§½å†…çš„æ¯”ç‰¹ä½çš„æ–¹å¼ã€‚EVMçš„æ¯ä¸€ä¸ªå‚¨å­˜æ§½éƒ½æ˜¯32å­—èŠ‚å¤§å°ï¼Œæ‰€ä»¥å®ƒèƒ½å®¹çº³ä¸‹256ä¸ªæ“ä½œçš„çŠ¶æ€è®°å½•ï¼Œç”¨æ»¡ä¹‹åæˆ‘ä»¬æ‰éœ€è¦ä½¿ç”¨ä¸‹ä¸€ä¸ªæ–°çš„å‚¨å­˜æ§½ã€‚

![nonces slot usage](./nonces-slots.drawio.svg)

å®ç°çš„æ–¹å¼å°±æ˜¯é€šè¿‡å°† `nonce` æ•°å€¼ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºï¼Œæˆªå‡ºä¸Šæ¸¸çš„248ä¸ªæ¯”ç‰¹ä½æ‰€ä»£è¡¨çš„æ•°å­—ï¼Œå°†å…¶æ˜ å°„è‡³å¯¹åº”çš„å”¯ä¸€å‚¨å­˜æ§½ï¼ˆè¿™ä¸€ç‚¹ä¸å‰é¢æœ´ç´ çš„æ–¹æ³•ç›¸ç±»ä¼¼ï¼‰ï¼Œç„¶åå–ä¸‹æ¸¸çš„8æ¯”ç‰¹ä½æ‰€ä»£è¡¨çš„æ•°å­—ç”¨æ¥æ ‡è®°è¿™ä¸ªå‚¨å­˜æ§½ä¸­ç›¸åº”ä½ç½®ä¸º`1`ã€‚å¦‚æœç”¨æˆ·æ˜¯é‡‡ç”¨ä¾‹å¦‚1ï¼Œ2ï¼Œ3è¿™æ ·ä»å°åˆ°å¤§é€’å¢çš„æ–¹å¼æ¥é€‰å– `nonce` çš„è€Œééšæœºé€‰å–ï¼Œé‚£ä¹ˆåªæœ‰åœ¨ä»–å®Œæˆäº†255æ¬¡æ“ä½œä¹‹åï¼Œåœ¨ç¬¬256æ¬¡çš„æ—¶å€™æ‰ä¼šå†ç”¨åˆ°ä¸€ä¸ªæ–°çš„å‚¨å­˜æ§½ã€‚

è®©æˆ‘ä»¬åœ¨åˆçº¦ä¸­å®ç°è¿™ä¸ªæ–¹æ³•ï¼š

```solidity
contract TransferRelay {
    // ...

    mapping (address => mapping (uint248 => uint256)) public signerNonceBitmap;

    function executeTransferMessage(
        Message calldata mess,
        uint8 v,
        bytes32 r,
        bytes32 s
    )
        external
    {
        require(mess.from != address(0), 'bad from');
        require(mess.validAfter < block.timestamp, 'not ready');
        require(!_getSignerNonceState(mess.from, mess.nonce), 'already consumed');
        {
            bytes32 messHash = keccak256(abi.encode(block.chainid, address(this), mess));
            require(ecrecover(messHash, v, r, s) == mess.from, 'bad signature');
        }
        // æ ‡è®°è¿™ä¸ªè¢«æˆæƒçš„äº¤æ˜“çŠ¶æ€ä¸ºå·²è¢«æ‰§è¡Œè¿‡
        _setSignerNonce(mess.from, mess.nonce);
        // æ‰§è¡Œè½¬ç§»äº¤æ˜“
        mess.token.transferFrom(address(mess.from), mess.to, mess.amount);
    }

    function _getSignerNonceState(address signer, uint256 nonce) private view returns (bool) {
        uint256 bitmap = signerNonceBitmap[signer][uint248(nonce >> 8)]; //ç”¨ä¸Šæ¸¸248æ¯”ç‰¹ä½æ•°å­—æ¥æ˜ å°„æ§½çš„ä½ç½®è¯»å–å­˜å‚¨çš„å€¼
        return bitmap & (1 << (nonce & 0xFF)) != 0; //å€¼çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸ç”¨nonceä¸‹æ¸¸8æ¯”ç‰¹ä½ä½ç§»è¿‡çš„1æ¥è¿›è¡ŒæŒ‰ä½ä¸”è¿ç®—ï¼Œå¾—åˆ°ç›¸åº”ä½ç½®æ˜¯è¢«æ ‡è®°æˆäº†0è¿˜æ˜¯1
    }

    function _setSignerNonce(address signer, uint256 nonce) private {
        signerNonceBitmap[signer][uint248(nonce >> 8)] |= 1 << (nonce & 0xFF); //ç”¨ä¸Šæ¸¸248æ¯”ç‰¹ä½æ•°å­—æ¥æ˜ å°„æ§½çš„ä½ç½®ï¼Œå†ç”¨ä¸‹æ¸¸8æ¯”ç‰¹ä½ï¼ˆå¯ä»£è¡¨256ä¸ªä½ç½®ï¼‰æ¥ä½ç§»1è¿›è¡Œæ ‡è®°ï¼Œå†ä¸è‡ªèº«è¿›è¡ŒæŒ‰ä½æˆ–è¿ç®—
    }
}
```

## æœ€åçš„æƒ³æ³•

- ä½å›¾noncesçš„æ–¹æ³•åœ¨ä¸€äº›ä¸»æµåè®®ä¸­è¢«é‡‡ç”¨ï¼Œæ¯”å¦‚Uniswap's [Permit2](https://github.com/Uniswap/permit2/blob/cc56ad0f3439c502c246fc5cfcc3db92bb8b7219/src/SignatureTransfer.sol#L142) å’Œ 0x's [Exchange Proxy](https://github.com/0xProject/protocol/blob/e66307ba319e8c3e2a456767403298b576abc85e/contracts/zero-ex/contracts/src/features/nft_orders/ERC721OrdersFeature.sol#L662).
- å³ä¾¿æ˜¯ä½ è¦è¿½è¸ªå’Œè®°å½•çš„çŠ¶æ€æ˜¯å¤§äº2ç§çš„æƒ…å†µï¼Œä¹Ÿä»æœ‰åŠæ³•ä½¿ç”¨ä½å›¾noncesæ¥å®Œæˆã€‚ä½ ä»…ä»…éœ€è¦å¢åŠ æ¯ä¸ªæ“ä½œæ‰€å¯¹åº”ä½¿ç”¨çš„æ¯”ç‰¹ä½æ•°é‡ç„¶åç›¸åº”è°ƒæ•´æ˜ å°„çš„å‡½æ•°è¡¨è¾¾å°±å¯ä»¥äº†ã€‚
- ä¸€ä¸ªæœ‰æ•ˆçš„ä¾‹å­çš„å®Œæ•´ä»£ç [åœ¨è¿™é‡Œ](./TransferRelay.sol)ï¼Œå®ƒçš„å„é¡¹æµ‹è¯•å¯è¯´æ˜å…¶ç”¨æ³•è¿˜æœ‰èŠ‚çœçš„gasæ•°é‡å¯ä»¥åœ¨[è¿™é‡Œ](../../test/TransferRelay.sol)æŸ¥çœ‹ã€‚
