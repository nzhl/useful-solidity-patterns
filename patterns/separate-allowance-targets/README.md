# å°†æˆæƒè½¬è´¦æƒé™çš„åˆçº¦å•ç‹¬æŠ½è±¡å‡ºæ¥

- [ğŸ“œ ç¤ºä¾‹ä»£ç ](./AllowanceTarget.sol)
- [ğŸ æµ‹è¯•](../../test/AllowanceTarget.t.sol)


é€šå¸¸ï¼Œéœ€è¦èŠ±è´¹ç”¨æˆ·çš„ ERC20 ä»£å¸çš„åè®®ä¼šè¦æ±‚ç”¨æˆ·åœ¨ä»–ä»¬çš„ä¸»è¦ä¸šåŠ¡é€»è¾‘åˆçº¦ä¸Šè®¾ç½®ä¸€ä¸ªæˆæƒï¼ˆé€šè¿‡ `ERC20.approve()`ï¼‰ï¼Œç„¶åå°±å¯ä»¥ç›´æ¥è°ƒç”¨ ERC20 åˆçº¦ä¸Šçš„ `transferFrom()` æ¥ä»ç”¨æˆ·é‚£é‡Œæ‹‰å–ä»£å¸ã€‚


![ç›´æ¥æˆæƒä¸šåŠ¡åˆçº¦](./direct-allowance.png)

ç„¶è€Œï¼Œå¦‚æœé€»è¾‘åˆçº¦çš„æ–°ç‰ˆæœ¬è¢«éƒ¨ç½²ï¼Œç°æœ‰çš„ç”¨æˆ·å°†ä¸å¾—ä¸åœ¨è¿™ä¸ªåˆçº¦ä¸Šè®¾ç½®æ‰€æœ‰æ–°çš„æˆæƒï¼Œå¹¶å¯èƒ½éœ€è¦æ’¤é”€åœ¨æ—§åˆçº¦ä¸Šè®¾ç½®çš„æˆæƒã€‚å¦‚æœä½ æ­£åœ¨ä»¥å¸¸è§„çš„é€Ÿåº¦è¿­ä»£ä½ çš„åˆçº¦ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å¤§é‡ç”¨æˆ·ä½“éªŒä¸Šçš„ä¸é€‚ã€‚


ä¸å…¶è®©ç”¨æˆ·åœ¨ä½ çš„ä¸šåŠ¡åˆçº¦ä¸Šè¿›è¡Œè½¬è´¦æˆæƒï¼Œä¸å¦‚éƒ¨ç½²ä¸€ä¸ªå•ä¸€ç›®çš„çš„â€œè½¬è´¦â€åˆçº¦ï¼Œç”¨æˆ·å¯ä»¥å‘è¯¥åˆçº¦è¿›è¡Œè½¬è´¦æˆæƒã€‚è¯¥åˆçº¦å¯ä»¥ä»£è¡¨æˆæƒè°ƒç”¨è€…æ‰§è¡Œ `transferFrom()` çš„å‡½æ•°ï¼Œè€Œå¯¹è¯¥åˆçº¦çš„è°ƒç”¨è€…åˆ™æ˜¯ä½ çš„ä¸šåŠ¡åˆçº¦ã€‚



![æˆæƒç»™å•ç‹¬æŠ½è±¡å‡ºæ¥çš„è½¬è´¦åˆçº¦](./allowance-target.png)

è¯¥è½¬è´¦åˆçº¦åœ¨ä¸šåŠ¡åè®®å‡çº§è¿‡ç¨‹ä¸­æ— éœ€è¿›è¡Œä»»ä½•æ”¹å˜ï¼Œéšç€åè®®çš„æ¼”å˜ï¼Œå¯ä»¥ç»™æ–°ç‰ˆæœ¬çš„ä¸šåŠ¡åˆçº¦æ·»åŠ æƒé™ï¼Œå› æ­¤åè®®åˆçº¦çš„æ–°ç‰ˆæœ¬å¯ä»¥ç«‹å³ä½¿ç”¨ç°æœ‰çš„ä»£å¸è®¸å¯ã€‚ä¹Ÿå¯ä»¥åˆ é™¤æˆæƒçš„è°ƒç”¨è€…ï¼Œè¿™æ˜¯å®‰å…¨åœ°åœç”¨å’Œè§£é™¤åè®®çš„è¿‡æ—¶ç»„ä»¶çš„ä¾¿æ·æ–¹å¼ã€‚



## è®¾è®¡ `æˆæƒè½¬è´¦` åˆçº¦


`æˆæƒè½¬è´¦` åˆçº¦åªéœ€è¦åšå¦‚ä¸‹å‡ ä»¶äº‹æƒ…:
- æš´éœ²ä¸€ä¸ª `spendFrom()` å‡½æ•°ï¼Œè¯¥å‡½æ•°åè¿‡æ¥è¢«ä¸šåŠ¡åˆçº¦è°ƒç”¨, é€šè¿‡`transferFrom()`æ›¿ä¸šåŠ¡åˆçº¦ä»ç”¨æˆ·ä¾§è½¬è´¦ç»™å®šæ•°é‡çš„ä»£å¸ã€‚
- ç»´æŠ¤å…è®¸è°ƒç”¨ `spendFrom()` çš„ä¸šåŠ¡åˆçº¦åœ°å€ã€‚
- å…è®¸ç®¡ç†å‘˜æ·»åŠ æ–°çš„ä¸šåŠ¡åœ°å€ã€‚

æ‰€ä»¥é¦–å…ˆæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸¤ä¸ªçŠ¶æ€å˜é‡ -- ä¸€ä¸ªäºè·Ÿè¸ªç®¡ç†å‘˜ï¼Œå¦ä¸€ä¸ªç”¨äºè·Ÿè¸ªæ˜¯å¦å…è®¸æŸä¸ªå…·ä½“çš„åœ°å€è°ƒç”¨ `spendFrom()`ï¼š

```solidity
address public admin;
mapping (address => bool) public authorized;
```

æˆ‘ä»¬åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–ç®¡ç†å‘˜ã€‚æˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œè®©ç®¡ç†å‘˜æˆæƒï¼ˆå’Œå–æ¶ˆæˆæƒï¼‰å¯ä»¥å‘èµ· `spendFrom()` è°ƒç”¨çš„åœ°å€ã€‚


```solidity
constructor(address admin_) {
    admin = admin_;
}

function setAuthority(address authority, bool enabled) external {
    require(msg.sender == admin, 'only admin can call this');
    authorized[authority] = enabled;
}
```

æœ€åï¼Œæˆ‘ä»¬æš´éœ² `spendFrom()` å‡½æ•°ï¼Œè¯¥å‡½æ•°åº”è¢«æˆæƒæ–¹ï¼ˆä¸šåŠ¡åˆçº¦ï¼‰çš„è¦æ±‚æ‰§è¡Œ `transferFrom()`ã€‚


```solidity
function spendFrom(IERC20 token, address from, address to, uint256 value)
    external
{
    require(authorized[msg.sender], 'only authorized');
    token.transferFrom(from, to, value);
}
```

ğŸ’¡ *æ³¨æ„ï¼Œåœ¨ä»¥å¤ªåŠä¸»ç½‘ä¸Šï¼Œç”±äºéƒ¨åˆ† ERC20 çš„å®ç°å¹¶ä¸ç¬¦åˆæ ‡å‡†è§„èŒƒ, ä½ å¯èƒ½ä¼šå¸Œæœ›ä»¥ä¸€ç§[å…¼å®¹æ‰€æœ‰ ERC20 ä»£å¸å®ç°çš„æ–¹å¼](../erc20-compatibility/)è°ƒç”¨ `transferFrom()`ã€‚*


## ç¤ºä¾‹

æ‰€åŒ…å«çš„[ç¤ºä¾‹](./AllowanceTarget.sol) æœ‰ä¸€ä¸ªå®Œå…¨å¯ç”¨çš„ `æˆæƒè½¬è´¦` åˆçº¦ï¼Œè¯¥åˆçº¦è¿˜æ”¯æŒä¸ç¬¦åˆæ ‡å‡†è§„èŒƒå®ç°çš„ ERC20 ä»£å¸ã€‚æ­¤å¤–[æµ‹è¯•](../../test/AllowanceTarget.sol)ä»ç”¨æˆ·å’Œä¸šåŠ¡åˆçº¦çš„è§’åº¦å±•ç¤ºäº†è¯¥åˆçº¦çš„ç”¨æ³•ã€‚


## å®é™…ä½¿ç”¨
- è¿™ç§æ¨¡å¼çš„æ—©æœŸçš„å®é™…åº”ç”¨åœºæ™¯ä¹‹ä¸€æ˜¯ä¸ 0x v1ï¼ˆç›´è‡³ v3ï¼‰çš„äº¤æ˜“æ‰€åè®®ï¼Œè¯¥åè®®å…·æœ‰ç‹¬ç«‹çš„["èµ„äº§ä»£ç†"](https://etherscan.io/address/0xf740b67da229f2f10bcbd38a7979992fcc71b8eb#code#F17#L1)åˆçº¦ï¼Œå®ƒä»¬æ˜¯ä»£å¸è½¬è´¦æˆæƒçš„ç›®æ ‡ï¼Œå¹¶åœ¨ç»“ç®—æœŸé—´ä»£è¡¨åè®®æ‰§è¡Œè½¬è´¦ã€‚è¿™äº›èµ„äº§ä»£ç†åœ¨åè®®çš„åç»­å¤šä¸ªç‰ˆæœ¬ä¸­æŒç»­ä½¿ç”¨ã€‚
- Opensea çš„ Seaport åè®®æœ‰ä¸€ä¸ª["å¯¼ç®¡"](https://github.com/ProjectOpenSea/seaport/blob/main/contracts/conduit/Conduit.sol)çš„æ¦‚å¿µï¼Œæœ¬è´¨ä¹Ÿæ˜¯ç‹¬ç«‹äºæ’®åˆåˆçº¦çš„ç‹¬ç«‹åˆçº¦ï¼Œç”¨æˆ·å‘å…¶æˆæƒè½¬è´¦æƒé™ï¼Œæ’®åˆåè®®åœ¨ç»“ç®—æœŸé—´é€šè¿‡å®ƒä»¬æ‰§è¡Œè½¬è´¦ã€‚

